<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Remote UI</title>
    <style>
        body {
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        button,
        label {
            font-size: 1.8rem;
        }
    </style>
</head>

<body>
    <!-- todo multiple -->
    <span style="visibility: hidden;" id="message"></span>
    <form action="fileupload" method="post" enctype="multipart/form-data">
        <label style="display: block; width: 100%;">
            <span>Upload file!</span>
            <input type="file" name="file" onchange="this.form.submit()">
        </label>
    </form>
    <div style="display: flex;">
        <button onclick="ws.send(JSON.stringify({type: 'press', button: 'audio_play'}))">play/pause</button>
    </div>
    <div style="width: 100%;height: 600px;border:1px solid black;border-radius: 3px;touch-action: none;color:gray;padding: 10px;margin: 10px;"
        id="touchPanel">touch panel</div>
    <script>
        //@ts-check
        const websocketUrl = new URL(location.href)
        if (websocketUrl.searchParams.get('uploadSuccess')) {
            message.style.visibility = ""
            message.innerText = `Uploaded successfully ${websocketUrl.searchParams.get('uploadSuccess')}`
        }
        websocketUrl.pathname = "ws"
        websocketUrl.protocol = "ws"
        let ws = new WebSocket(websocketUrl)
        let start
        let moved
        touchPanel.addEventListener('pointerdown', (event) => {
            moved = false
            start = { clientX: event.clientX, clientY: event.clientY, time: Date.now() }
        })
        let last = Date.now()
        let lastMoved = 0
        touchPanel.addEventListener('pointermove', (e) => {
            if (!start) return
            const data = { x: e.clientX - start.clientX, y: e.clientY - start.clientY }
            if (data.x === 0 && data.y === 0) return
            let d = 4
            data.x /= d
            data.y /= d
            if (Date.now() - last < 5) return
            // if (data.x < 1) data.x = 0
            // if (data.y < 1) data.y = 0
            data.x = Math.round(data.x)
            data.y = Math.round(data.y)
            last = Date.now()
            moved = true
            ws.send(JSON.stringify({ type: 'move', ...data }))
        })
        touchPanel.addEventListener('pointerup', () => {
            if (!moved) {
                console.log('click')
                ws.send(JSON.stringify({ type: 'click', button: Date.now() - start.time > 500 ? 'right' : undefined }))
            }
            start = undefined
        })
    </script>
</body>

</html>
